<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>팀플레이 유형 데이터</title>
  
  <meta name="theme-color" content="#6366f1">
  <meta name="description" content="팀플레이 유형 데이터 관리 시스템">
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    
    /* 로그인 화면 */
    .auth-container {
      max-width: 400px;
      margin: 100px auto;
      background: white;
      padding: 40px;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    
    .auth-container h1 {
      color: #6366f1;
      margin-bottom: 30px;
      text-align: center;
      font-size: 24px;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: #374151;
      font-weight: 500;
    }
    
    .form-group input {
      width: 100%;
      padding: 12px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 14px;
    }
    
    .form-group input:focus {
      outline: none;
      border-color: #6366f1;
    }
    
    .btn {
      width: 100%;
      padding: 12px;
      background: #6366f1;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
    }
    
    .btn:hover {
      background: #4f46e5;
    }
    
    .auth-switch {
      text-align: center;
      margin-top: 20px;
      color: #6b7280;
    }
    
    .auth-switch a {
      color: #6366f1;
      text-decoration: none;
      font-weight: 600;
    }
    
    /* 대시보드 */
    .dashboard {
      display: none;
    }
    
    .dashboard.active {
      display: block;
    }
    
    .header {
      background: white;
      padding: 20px 30px;
      border-radius: 15px;
      margin-bottom: 30px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .header h1 {
      color: #6366f1;
      font-size: 24px;
    }
    
    .header-info {
      display: flex;
      gap: 20px;
      align-items: center;
    }
    
    .user-email {
      color: #6b7280;
      font-size: 14px;
    }
    
    .btn-logout {
      padding: 8px 16px;
      background: #ef4444;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
    }
    
    .btn-logout:hover {
      background: #dc2626;
    }
    
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .stat-card {
      background: white;
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    
    .stat-label {
      color: #6b7280;
      font-size: 14px;
      margin-bottom: 8px;
    }
    
    .stat-value {
      font-size: 32px;
      font-weight: 700;
      color: #1f2937;
    }
    
    .stat-card.pending .stat-value {
      color: #f59e0b;
    }
    
    .stat-card.approved .stat-value {
      color: #10b981;
    }
    
    .stat-card.rejected .stat-value {
      color: #ef4444;
    }
    
    /* 탭 */
    .tabs {
      background: white;
      border-radius: 15px;
      padding: 0;
      margin-bottom: 30px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    
    .tab-nav {
      display: flex;
      border-bottom: 2px solid #e5e7eb;
    }
    
    .tab-btn {
      flex: 1;
      padding: 20px;
      background: none;
      border: none;
      font-size: 16px;
      font-weight: 600;
      color: #6b7280;
      cursor: pointer;
      position: relative;
    }
    
    .tab-btn:hover {
      background: #f9fafb;
    }
    
    .tab-btn.active {
      color: #6366f1;
    }
    
    .tab-btn.active::after {
      content: '';
      position: absolute;
      bottom: -2px;
      left: 0;
      right: 0;
      height: 3px;
      background: #6366f1;
    }
    
    .tab-badge {
      background: #e5e7eb;
      color: #6b7280;
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 12px;
      margin-left: 6px;
    }
    
    .tab-btn.active .tab-badge {
      background: #6366f1;
      color: white;
    }
    
    .tab-content {
      padding: 30px;
    }
    
    .tab-pane {
      display: none;
    }
    
    .tab-pane.active {
      display: block;
    }
    
    /* 검색 */
    .search-panel {
      background: #f9fafb;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
    }
    
    .search-filters {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    .search-filters select,
    .search-filters input {
      padding: 10px;
      border: 2px solid #e5e7eb;
      border-radius: 6px;
      font-size: 14px;
    }
    
    .search-filters select {
      min-width: 150px;
    }
    
    .search-filters input {
      flex: 1;
      min-width: 200px;
    }
    
    .search-filters button {
      padding: 10px 20px;
      background: #6366f1;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
    }
    
    .search-filters button:hover {
      background: #4f46e5;
    }
    
    /* 카테고리 트리 */
    .category-group {
      margin-bottom: 20px;
    }
    
    .category-header {
      background: #f3f4f6;
      padding: 15px;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
    }
    
    .category-header:hover {
      background: #e5e7eb;
    }
    
    .category-children {
      padding-left: 20px;
      margin-top: 10px;
    }
    
    .subcategory {
      margin-bottom: 15px;
    }
    
    .subcategory-header {
      background: #fef3c7;
      padding: 12px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
    }
    
    .subcategory-header:hover {
      background: #fde68a;
    }
    
    .subcategory-cases {
      padding-left: 20px;
      margin-top: 10px;
    }
    
    /* 케이스 카드 */
    .case-card {
      background: white;
      border: 2px solid #e5e7eb;
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 12px;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .case-card:hover {
      border-color: #6366f1;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(99, 102, 241, 0.1);
    }
    
    .case-title {
      font-weight: 600;
      margin-bottom: 10px;
      color: #1f2937;
    }
    
    .case-details {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 8px;
      margin-bottom: 10px;
    }
    
    .detail-row {
      font-size: 13px;
      color: #6b7280;
    }
    
    .detail-label {
      font-weight: 600;
      margin-right: 6px;
    }
    
    .detail-value {
      color: #374151;
    }
    
    .case-link {
      color: #6366f1;
      text-decoration: none;
      font-size: 13px;
      display: inline-block;
      margin-top: 8px;
    }
    
    .case-link:hover {
      text-decoration: underline;
    }
    
    /* 항목 */
    .item {
      background: #f9fafb;
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 12px;
      border-left: 4px solid #6366f1;
    }
    
    .item-title {
      font-size: 15px;
      font-weight: 600;
      color: #1f2937;
      margin-bottom: 8px;
    }
    
    .item-meta {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      margin-bottom: 8px;
    }
    
    .meta-tag {
      background: white;
      color: #6b7280;
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 11px;
    }
    
    .item-preview {
      color: #6b7280;
      font-size: 13px;
      margin: 8px 0;
      line-height: 1.5;
    }
    
    .item-link {
      color: #6366f1;
      font-size: 12px;
      text-decoration: none;
      display: inline-block;
      margin: 8px 0;
    }
    
    .item-link:hover {
      text-decoration: underline;
    }
    
    .item-options {
      display: flex;
      gap: 8px;
      margin-top: 12px;
      flex-wrap: wrap;
    }
    
    .option-section {
      width: 100%;
      margin-top: 10px;
    }
    
    .option-section-title {
      font-size: 12px;
      font-weight: 600;
      color: #6b7280;
      margin-bottom: 8px;
    }
    
    .option-btn {
      padding: 6px 12px;
      border: 2px solid #e5e7eb;
      background: white;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
    }
    
    .option-btn:hover {
      border-color: #6366f1;
      background: #f0f0ff;
    }
    
    .option-btn.approve {
      border-color: #10b981;
      color: #10b981;
    }
    
    .option-btn.approve:hover {
      background: #d1fae5;
    }
    
    .option-btn.reject {
      border-color: #ef4444;
      color: #ef4444;
    }
    
    .option-btn.reject:hover {
      background: #fee2e2;
    }
    
    .percentage-badge {
      background: #6366f1;
      color: white;
      padding: 2px 5px;
      border-radius: 3px;
      font-size: 10px;
      font-weight: 600;
      margin-left: 4px;
    }
    
    /* 모달 */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      padding: 20px;
      overflow-y: auto;
    }
    
    .modal.active {
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .modal-content {
      background: white;
      border-radius: 15px;
      max-width: 600px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    
    .modal-header {
      padding: 25px;
      border-bottom: 2px solid #e5e7eb;
      display: flex;
      justify-content: space-between;
      align-items: start;
    }
    
    .modal-title {
      font-size: 20px;
      font-weight: 700;
      color: #1f2937;
      line-height: 1.4;
      flex: 1;
      padding-right: 20px;
    }
    
    .modal-close {
      background: #f3f4f6;
      border: none;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 18px;
      color: #6b7280;
    }
    
    .modal-close:hover {
      background: #e5e7eb;
    }
    
    .modal-body {
      padding: 25px;
    }
    
    .modal-section {
      margin-bottom: 20px;
    }
    
    .modal-label {
      font-size: 12px;
      font-weight: 600;
      color: #6b7280;
      text-transform: uppercase;
      margin-bottom: 8px;
    }
    
    .modal-text {
      color: #374151;
      font-size: 14px;
      line-height: 1.6;
    }
    
    .modal-link {
      color: #6366f1;
      text-decoration: none;
      word-break: break-all;
    }
    
    .modal-link:hover {
      text-decoration: underline;
    }
    
    .modal-footer {
      padding: 20px 25px;
      border-top: 2px solid #e5e7eb;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    .modal-btn {
      flex: 1;
      min-width: 120px;
      padding: 12px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
    }
    
    .modal-btn-primary {
      background: #6366f1;
      color: white;
    }
    
    .modal-btn-primary:hover {
      background: #4f46e5;
    }
    
    .modal-btn-danger {
      background: #ef4444;
      color: white;
    }
    
    .modal-btn-danger:hover {
      background: #dc2626;
    }
    
    .modal-btn-secondary {
      background: #f3f4f6;
      color: #374151;
    }
    
    .modal-btn-secondary:hover {
      background: #e5e7eb;
    }
    
    /* 빈 상태 */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #6b7280;
    }
    
    .empty-state-icon {
      font-size: 64px;
      margin-bottom: 16px;
      opacity: 0.5;
    }
    
    .empty-state-text {
      font-size: 16px;
    }
    
    /* 분류 근거 */
    .reason-box {
      background: #f9fafb;
      padding: 15px;
      border-radius: 8px;
      margin-top: 10px;
    }
    
    .reason-title {
      font-size: 13px;
      font-weight: 600;
      color: #6b7280;
      margin-bottom: 8px;
    }
    
    .reason-content {
      font-size: 13px;
      color: #374151;
      line-height: 1.6;
    }
    
    .reason-keywords {
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
      margin-top: 6px;
    }
    
    .reason-keyword {
      background: #e0e7ff;
      color: #4f46e5;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 11px;
    }
    
    .problem-tag {
      background: #fee2e2;
      color: #dc2626;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 11px;
    }
    
    /* 반응형 */
    @media (max-width: 768px) {
      body {
        padding: 10px;
      }
      
      .header {
        flex-direction: column;
        gap: 15px;
      }
      
      .header-info {
        flex-direction: column;
        width: 100%;
      }
      
      .stats {
        grid-template-columns: 1fr;
      }
      
      .tab-nav {
        flex-direction: column;
      }
      
      .search-filters {
        flex-direction: column;
      }
      
      .search-filters select,
      .search-filters input {
        width: 100%;
      }
      
      .case-details {
        grid-template-columns: 1fr;
      }
      
      .modal-footer {
        flex-direction: column;
      }
      
      .modal-btn {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <!-- 로그인/회원가입 -->
  <div id="authContainer" class="auth-container">
    <h1>팀플레이 유형 데이터</h1>
    <div id="loginForm">
      <div class="form-group">
        <label>이메일</label>
        <input type="email" id="loginEmail" placeholder="your@email.com">
      </div>
      <div class="form-group">
        <label>비밀번호</label>
        <input type="password" id="loginPassword" placeholder="••••••••">
      </div>
      <button class="btn" onclick="login()">로그인</button>
      <div class="auth-switch">
        계정이 없으신가요? <a href="#" onclick="toggleAuth(); return false;">회원가입</a>
      </div>
    </div>
    
    <div id="signupForm" style="display: none;">
      <div class="form-group">
        <label>이메일</label>
        <input type="email" id="signupEmail" placeholder="your@email.com">
      </div>
      <div class="form-group">
        <label>비밀번호</label>
        <input type="password" id="signupPassword" placeholder="••••••••">
      </div>
      <button class="btn" onclick="signup()">회원가입</button>
      <div class="auth-switch">
        이미 계정이 있으신가요? <a href="#" onclick="toggleAuth(); return false;">로그인</a>
      </div>
    </div>
  </div>

  <!-- 대시보드 -->
  <div id="dashboard" class="dashboard">
    <div class="container">
      <!-- 헤더 -->
      <div class="header">
        <h1>팀플레이 유형 데이터</h1>
        <div class="header-info">
          <span class="user-email" id="userEmail"></span>
          <button class="btn-logout" onclick="logout()">로그아웃</button>
        </div>
      </div>

      <!-- 통계 -->
      <div class="stats">
        <div class="stat-card">
          <div class="stat-label">총 수집</div>
          <div class="stat-value" id="statTotal">0</div>
        </div>
        <div class="stat-card pending">
          <div class="stat-label">결정 대기</div>
          <div class="stat-value" id="statPending">0</div>
        </div>
        <div class="stat-card approved">
          <div class="stat-label">승인함</div>
          <div class="stat-value" id="statApproved">0</div>
        </div>
        <div class="stat-card rejected">
          <div class="stat-label">거절함</div>
          <div class="stat-value" id="statRejected">0</div>
        </div>
      </div>

      <!-- 탭 -->
      <div class="tabs">
        <div class="tab-nav">
          <button class="tab-btn active" data-tab="pending">
            결정 필요
            <span class="tab-badge" id="pendingCount">0</span>
          </button>
          <button class="tab-btn" data-tab="approved">
            승인함
            <span class="tab-badge" id="approvedCount">0</span>
          </button>
          <button class="tab-btn" data-tab="rejected">
            거절함
            <span class="tab-badge" id="rejectedCount">0</span>
          </button>
          <button class="tab-btn" data-tab="categories">
            카테고리별 보기
            <span class="tab-badge" id="categoriesCount">0</span>
          </button>
        </div>
        
        <div class="tab-content">
          <!-- 결정 필요 -->
          <div class="tab-pane active" id="pendingPane">
            <div id="pendingItems"></div>
          </div>
          
          <!-- 승인함 -->
          <div class="tab-pane" id="approvedPane">
            <div class="search-panel">
              <div class="search-filters">
                <select id="searchSubject">
                  <option value="">전체 주체</option>
                  <option value="학생">학생</option>
                  <option value="직장인">직장인</option>
                  <option value="정치인">정치인</option>
                  <option value="크리에이터">크리에이터</option>
                  <option value="활동가">활동가</option>
                  <option value="기업/단체">기업/단체</option>
                  <option value="개발자">개발자</option>
                </select>
                
                <select id="searchType">
                  <option value="">전체 유형</option>
                  <option value="주도형">주도형</option>
                  <option value="비전제시형">비전제시형</option>
                  <option value="전략가형">전략가형</option>
                  <option value="실행형">실행형</option>
                  <option value="완수형">완수형</option>
                  <option value="속도형">속도형</option>
                  <option value="협력형">협력형</option>
                  <option value="조율자형">조율자형</option>
                  <option value="지원형">지원형</option>
                  <option value="소통형">소통형</option>
                  <option value="경청형">경청형</option>
                  <option value="중재형">중재형</option>
                  <option value="혁신형">혁신형</option>
                  <option value="창의형">창의형</option>
                  <option value="분석형">분석형</option>
                  <option value="신뢰구축형">신뢰구축형</option>
                </select>
                
                <input type="text" id="searchContent" placeholder="내용 검색...">
                
                <button onclick="searchCases()">검색</button>
              </div>
            </div>
            <div id="approvedItems"></div>
          </div>
          
          <!-- 거절함 -->
          <div class="tab-pane" id="rejectedPane">
            <div id="rejectedItems"></div>
          </div>
          
          <!-- 카테고리별 보기 -->
          <div class="tab-pane" id="categoriesPane">
            <div id="categoryTree"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 상세보기 모달 -->
  <div id="detailModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title" id="modalTitle"></h2>
        <button class="modal-close" onclick="closeModal()">✕</button>
      </div>
      <div class="modal-body" id="modalBody"></div>
      <div class="modal-footer" id="modalFooter"></div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

  <script>
    // Firebase 설정
    const firebaseConfig = {
      apiKey: "AIzaSyAmv5MlHGbzrZBw8lsMxt4vXYTwcetRcxI",
      authDomain: "tpt-learning-49601.firebaseapp.com",
      projectId: "tpt-learning-49601",
      storageBucket: "tpt-learning-49601.firebasestorage.app",
      messagingSenderId: "602423446232",
      appId: "1:602423446232:web:48ebe5af774affda7225ad"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let currentUser = null;
    let unsubscribe = null;
    let currentData = null;

    // 인증 상태 감지
    auth.onAuthStateChanged(user => {
      if (user) {
        currentUser = user;
        document.getElementById('authContainer').style.display = 'none';
        document.getElementById('dashboard').classList.add('active');
        document.getElementById('userEmail').textContent = user.email;
        loadDashboard();
      } else {
        currentUser = null;
        document.getElementById('authContainer').style.display = 'block';
        document.getElementById('dashboard').classList.remove('active');
        if (unsubscribe) unsubscribe();
      }
    });

    // 탭 전환
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const tab = btn.dataset.tab;
        
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        
        document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
        document.getElementById(tab + 'Pane').classList.add('active');
        
        if (tab === 'categories') {
          renderCategoryTree(currentData?.approvedItems || []);
        }
      });
    });

    // 로그인/회원가입
    function toggleAuth() {
      const login = document.getElementById('loginForm');
      const signup = document.getElementById('signupForm');
      if (login.style.display === 'none') {
        login.style.display = 'block';
        signup.style.display = 'none';
      } else {
        login.style.display = 'none';
        signup.style.display = 'block';
      }
    }

    async function login() {
      const email = document.getElementById('loginEmail').value;
      const password = document.getElementById('loginPassword').value;
      
      try {
        await auth.signInWithEmailAndPassword(email, password);
      } catch (error) {
        alert('로그인 실패: ' + error.message);
      }
    }

    async function signup() {
      const email = document.getElementById('signupEmail').value;
      const password = document.getElementById('signupPassword').value;
      
      try {
        const userCredential = await auth.createUserWithEmailAndPassword(email, password);
        await db.collection('users').doc(userCredential.user.uid).set({
          email: email,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          stats: { total: 0, pending: 0, approved: 0, rejected: 0 },
          approvalQueue: [],
          approvedItems: [],
          rejectedItems: []
        });
      } catch (error) {
        alert('회원가입 실패: ' + error.message);
      }
    }

    function logout() {
      auth.signOut();
    }

    // 대시보드 로드
    function loadDashboard() {
      const userDocRef = db.collection('users').doc(currentUser.uid);
      
      unsubscribe = userDocRef.onSnapshot(doc => {
        if (!doc.exists) {
          userDocRef.set({
            email: currentUser.email,
            stats: { total: 0, pending: 0, approved: 0, rejected: 0 },
            approvalQueue: [],
            approvedItems: [],
            rejectedItems: []
          });
          return;
        }
        
        const data = doc.data();
        currentData = data;
        
        // 통계
        document.getElementById('statTotal').textContent = data.stats?.total || 0;
        document.getElementById('statPending').textContent = data.stats?.pending || 0;
        document.getElementById('statApproved').textContent = data.stats?.approved || 0;
        document.getElementById('statRejected').textContent = data.stats?.rejected || 0;
        
        // 탭 카운트
        document.getElementById('pendingCount').textContent = (data.approvalQueue || []).length;
        document.getElementById('approvedCount').textContent = (data.approvedItems || []).length;
        document.getElementById('rejectedCount').textContent = (data.rejectedItems || []).length;
        document.getElementById('categoriesCount').textContent = (data.approvedItems || []).length;
        
        // 렌더링
        renderPendingItems(data.approvalQueue || []);
        renderApprovedItems(data.approvedItems || []);
        renderRejectedItems(data.rejectedItems || []);
      });
    }

    // 결정 필요 렌더링
    function renderPendingItems(items) {
      const container = document.getElementById('pendingItems');
      
      if (items.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">✅</div>
            <div class="empty-state-text">모든 항목을 처리했습니다!</div>
          </div>
        `;
        return;
      }
      
      container.innerHTML = items.map((item, index) => {
        if (item.type === 'keyword') {
          return `
            <div class="item">
              <div class="item-title">새 키워드 제안: "${item.keyword}"</div>
              <div class="item-preview">${item.description}</div>
              
              <div class="option-section">
                <div class="option-section-title">주제 분류</div>
                <div class="item-options">
                  <button class="option-btn" onclick="handleKeywordCategory('${index}', 'primary')">
                    1차 카테고리
                  </button>
                  <button class="option-btn" onclick="handleKeywordCategory('${index}', 'secondary')">
                    2차 카테고리
                  </button>
                  <button class="option-btn" onclick="handleKeywordCategory('${index}', 'exclude')">
                    제외
                  </button>
                </div>
              </div>
              
              <div class="option-section">
                <div class="option-section-title">검색 키워드</div>
                <div class="item-options">
                  <button class="option-btn approve" onclick="handleKeywordSearch('${index}', 'use')">
                    반영
                  </button>
                  <button class="option-btn reject" onclick="handleKeywordSearch('${index}', 'ignore')">
                    제외
                  </button>
                </div>
              </div>
            </div>
          `;
        } else {
          return `
            <div class="item">
              <div class="item-title">${item.title}</div>
              <div class="item-meta">
                <span class="meta-tag">${item.source === 'blog' ? '블로그' : '뉴스'}</span>
                <span class="meta-tag">${item.keyword}</span>
                ${item.postDate ? `<span class="meta-tag">${item.postDate}</span>` : ''}
              </div>
              ${item.content ? `<div class="item-preview">${item.content}</div>` : ''}
              ${item.link ? `<a href="${item.link}" target="_blank" class="item-link" onclick="event.stopPropagation()">원문 보기</a>` : ''}
              
              <div class="option-section">
                <div class="option-section-title">행위 주체</div>
                <div class="item-options">
                  ${item.subjectOptions?.map((opt, i) => `
                    <button class="option-btn" onclick="selectSubject(${index}, ${i})">
                      ${opt.label}
                      <span class="percentage-badge">${opt.confidence}%</span>
                    </button>
                  `).join('') || ''}
                </div>
              </div>
              
              <div class="option-section">
                <div class="option-section-title">긍정적 유형</div>
                <div class="item-options">
                  ${item.typeOptions?.map((opt, i) => `
                    <button class="option-btn" onclick="selectType(${index}, ${i})">
                      ${opt.type}
                      <span class="percentage-badge">${opt.confidence}%</span>
                    </button>
                  `).join('') || ''}
                </div>
              </div>
              
              <div class="item-options">
                <button class="option-btn reject" onclick="rejectItem(${index})">
                  반려
                </button>
              </div>
            </div>
          `;
        }
      }).join('');
    }

    // 승인함/거절함 렌더링
    function renderApprovedItems(items) {
      const container = document.getElementById('approvedItems');
      
      if (items.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-text">승인한 항목이 없습니다</div>
          </div>
        `;
        return;
      }
      
      container.innerHTML = items.map((item, index) => `
        <div class="case-card" onclick="showDetail('approved', ${index})">
          <div class="case-title">${item.title}</div>
          <div class="case-details">
            <div class="detail-row">
              <span class="detail-label">주체:</span>
              <span class="detail-value">${item.selectedSubject || '미지정'}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">유형:</span>
              <span class="detail-value">${item.selectedType || '미지정'}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">데이터:</span>
              <span class="detail-value">${item.source === 'blog' ? '블로그' : '뉴스'}</span>
            </div>
            ${item.postDate ? `
              <div class="detail-row">
                <span class="detail-label">날짜:</span>
                <span class="detail-value">${item.postDate}</span>
              </div>
            ` : ''}
          </div>
          ${item.link ? `<a href="${item.link}" target="_blank" class="case-link" onclick="event.stopPropagation()">원문 보기</a>` : ''}
        </div>
      `).join('');
    }

    function renderRejectedItems(items) {
      const container = document.getElementById('rejectedItems');
      
      if (items.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-text">거절한 항목이 없습니다</div>
          </div>
        `;
        return;
      }
      
      container.innerHTML = items.map((item, index) => `
        <div class="case-card" onclick="showDetail('rejected', ${index})">
          <div class="case-title">${item.title || item.content}</div>
          ${item.link ? `<a href="${item.link}" target="_blank" class="case-link" onclick="event.stopPropagation()">원문 보기</a>` : ''}
        </div>
      `).join('');
    }

    // 카테고리 트리 렌더링
    function renderCategoryTree(items) {
      const container = document.getElementById('categoryTree');
      
      if (items.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-text">승인한 항목이 없습니다</div>
          </div>
        `;
        return;
      }
      
      // 카테고리별 그룹핑
      const tree = {};
      items.forEach(item => {
        const primary = item.primaryCategory || '미분류';
        if (!tree[primary]) tree[primary] = [];
        tree[primary].push(item);
      });
      
      let html = '';
      for (const [category, cases] of Object.entries(tree)) {
        html += `
          <div class="category-group">
            <div class="category-header" onclick="toggleCategory('${category}')">
              ${category} (${cases.length}건)
            </div>
            <div class="category-children" id="cat-${category}" style="display: none;">
        `;
        
        cases.forEach((item, index) => {
          html += `
            <div class="case-card" onclick="showCategoryDetail('${category}', ${index})">
              <div class="case-title">${item.title}</div>
              <div class="case-details">
                <div class="detail-row">
                  <span class="detail-label">주체:</span>
                  <span class="detail-value">${item.selectedSubject || '미지정'}</span>
                </div>
                <div class="detail-row">
                  <span class="detail-label">유형:</span>
                  <span class="detail-value">${item.selectedType || '미지정'}</span>
                </div>
                <div class="detail-row">
                  <span class="detail-label">데이터:</span>
                  <span class="detail-value">${item.source === 'blog' ? '블로그' : '뉴스'}</span>
                </div>
                ${item.postDate ? `
                  <div class="detail-row">
                    <span class="detail-label">날짜:</span>
                    <span class="detail-value">${item.postDate}</span>
                  </div>
                ` : ''}
              </div>
              ${item.classificationReason ? `
                <div class="reason-box">
                  <div class="reason-title">분류 근거</div>
                  <div class="reason-keywords">
                    ${item.classificationReason.typeKeywords?.map(k => `<span class="reason-keyword">${k}</span>`).join('') || ''}
                    ${item.classificationReason.problems?.map(p => `<span class="problem-tag">극복: ${p}</span>`).join('') || ''}
                  </div>
                </div>
              ` : ''}
              ${item.link ? `<a href="${item.link}" target="_blank" class="case-link" onclick="event.stopPropagation()">원문 보기</a>` : ''}
            </div>
          `;
        });
        
        html += `
            </div>
          </div>
        `;
      }
      
      container.innerHTML = html;
    }

    function toggleCategory(category) {
      const el = document.getElementById('cat-' + category);
      el.style.display = el.style.display === 'none' ? 'block' : 'none';
    }

    // 검색
    function searchCases() {
      const subject = document.getElementById('searchSubject').value;
      const type = document.getElementById('searchType').value;
      const content = document.getElementById('searchContent').value.toLowerCase();
      
      let results = currentData.approvedItems || [];
      
      if (subject) {
        results = results.filter(item => item.selectedSubject === subject);
      }
      
      if (type) {
        results = results.filter(item => item.selectedType === type);
      }
      
      if (content) {
        results = results.filter(item => {
          const searchText = ((item.title || '') + ' ' + (item.content || '')).toLowerCase();
          return searchText.includes(content);
        });
      }
      
      renderApprovedItems(results);
    }

    // 주체 선택
    let selectedSubjectIndex = null;
    async function selectSubject(itemIndex, optionIndex) {
      selectedSubjectIndex = optionIndex;
      // 주체 선택 시 시각적 피드백
      alert('주체 선택됨. 이제 유형을 선택하세요.');
    }

    // 유형 선택 (승인)
    async function selectType(itemIndex, optionIndex) {
      if (selectedSubjectIndex === null) {
        alert('먼저 주체를 선택하세요.');
        return;
      }
      
      const userDocRef = db.collection('users').doc(currentUser.uid);
      const item = currentData.approvalQueue[itemIndex];
      
      const selectedSubject = item.subjectOptions[selectedSubjectIndex];
      const selectedType = item.typeOptions[optionIndex];
      
      const newQueue = [...currentData.approvalQueue];
      newQueue.splice(itemIndex, 1);
      
      const approvedItem = {
        ...item,
        selectedSubject: selectedSubject.label,
        selectedType: selectedType.type,
        primaryCategory: item.primaryCategories[0]?.label || '기타',
        classificationReason: {
          primaryKeywords: item.primaryCategories[0]?.keywords || [],
          subjectKeywords: selectedSubject.keywords || [],
          typeKeywords: selectedType.keywords || [],
          problems: selectedType.problems || [],
          confidence: selectedType.confidence
        },
        decidedAt: new Date().toISOString()
      };
      
      const approvedItems = [approvedItem, ...(currentData.approvedItems || [])];
      
      await userDocRef.update({
        approvalQueue: newQueue,
        approvedItems,
        'stats.pending': newQueue.length,
        'stats.approved': approvedItems.length
      });
      
      selectedSubjectIndex = null;
    }

    // 반려
    async function rejectItem(index) {
      const reason = prompt('반려 이유:\n1. 행위주체 모호\n2. 유형 모호\n3. 관련성 부족\n\n숫자를 입력하세요:');
      
      if (!reason) return;
      
      const reasons = ['', '행위주체 모호', '유형 모호', '관련성 부족'];
      const reasonText = reasons[parseInt(reason)] || '기타';
      
      const userDocRef = db.collection('users').doc(currentUser.uid);
      const item = currentData.approvalQueue[index];
      
      const newQueue = [...currentData.approvalQueue];
      newQueue.splice(index, 1);
      
      const rejectedItem = {
        ...item,
        rejectionReason: reasonText,
        decidedAt: new Date().toISOString()
      };
      
      const rejectedItems = [rejectedItem, ...(currentData.rejectedItems || [])];
      
      await userDocRef.update({
        approvalQueue: newQueue,
        rejectedItems,
        'stats.pending': newQueue.length,
        'stats.rejected': rejectedItems.length
      });
    }

    // 키워드 제안 처리
    async function handleKeywordCategory(index, level) {
      // 일단 저장만 (나중에 구현)
      alert(`키워드 카테고리: ${level} 선택됨`);
    }

    async function handleKeywordSearch(index, action) {
      const userDocRef = db.collection('users').doc(currentUser.uid);
      const item = currentData.approvalQueue[index];
      
      const newQueue = [...currentData.approvalQueue];
      newQueue.splice(index, 1);
      
      // 검색 키워드로 사용할지 여부 저장
      // TODO: 실제 키워드 목록에 추가하는 로직
      
      await userDocRef.update({
        approvalQueue: newQueue,
        'stats.pending': newQueue.length
      });
    }

    // 상세보기 모달
    function showDetail(type, index) {
      const items = type === 'approved' ? currentData.approvedItems : currentData.rejectedItems;
      const item = items[index];
      
      document.getElementById('modalTitle').textContent = item.title;
      
      let bodyHtml = `
        <div class="modal-section">
          <div class="modal-label">주체</div>
          <div class="modal-text">${item.selectedSubject || '미지정'}</div>
        </div>
        <div class="modal-section">
          <div class="modal-label">유형</div>
          <div class="modal-text">${item.selectedType || '미지정'}</div>
        </div>
        <div class="modal-section">
          <div class="modal-label">데이터 유형</div>
          <div class="modal-text">${item.source === 'blog' ? '블로그' : '뉴스'}</div>
        </div>
      `;
      
      if (item.postDate) {
        bodyHtml += `
          <div class="modal-section">
            <div class="modal-label">게시 날짜</div>
            <div class="modal-text">${item.postDate}</div>
          </div>
        `;
      }
      
      if (item.content) {
        bodyHtml += `
          <div class="modal-section">
            <div class="modal-label">내용</div>
            <div class="modal-text">${item.content}</div>
          </div>
        `;
      }
      
      if (item.classificationReason) {
        bodyHtml += `
          <div class="modal-section">
            <div class="modal-label">분류 근거</div>
            <div class="reason-box">
              <div class="reason-content">
                유형 키워드: ${item.classificationReason.typeKeywords?.join(', ') || '없음'}<br>
                주체 키워드: ${item.classificationReason.subjectKeywords?.join(', ') || '없음'}<br>
                신뢰도: ${item.classificationReason.confidence || 0}%
                ${item.classificationReason.problems?.length > 0 ? `<br>극복한 문제: ${item.classificationReason.problems.join(', ')}` : ''}
              </div>
            </div>
          </div>
        `;
      }
      
      if (item.link) {
        bodyHtml += `
          <div class="modal-section">
            <div class="modal-label">원문 링크</div>
            <a href="${item.link}" target="_blank" class="modal-link">${item.link}</a>
          </div>
        `;
      }
      
      document.getElementById('modalBody').innerHTML = bodyHtml;
      
      let footerHtml = `
        <button class="modal-btn modal-btn-primary" onclick="reconsider('${type}', ${index})">
          다시 검토
        </button>
        <button class="modal-btn modal-btn-secondary" onclick="closeModal()">
          닫기
        </button>
      `;
      
      document.getElementById('modalFooter').innerHTML = footerHtml;
      document.getElementById('detailModal').classList.add('active');
    }

    function showCategoryDetail(category, index) {
      const items = currentData.approvedItems.filter(i => (i.primaryCategory || '미분류') === category);
      showDetail('approved', currentData.approvedItems.indexOf(items[index]));
    }

    function closeModal() {
      document.getElementById('detailModal').classList.remove('active');
    }

    // 재검토
    async function reconsider(type, index) {
      const userDocRef = db.collection('users').doc(currentUser.uid);
      
      const items = type === 'approved' ? currentData.approvedItems : currentData.rejectedItems;
      const item = items[index];
      
      const { decidedAt, selectedSubject, selectedType, primaryCategory, secondaryCategory, classificationReason, rejectionReason, ...originalItem } = item;
      
      // approvalQueue로 이동
      const newQueue = [originalItem, ...(currentData.approvalQueue || [])];
      
      const updatedItems = [...items];
      updatedItems.splice(index, 1);
      
      await userDocRef.update({
        [type === 'approved' ? 'approvedItems' : 'rejectedItems']: updatedItems,
        approvalQueue: newQueue,
        [`stats.${type}`]: updatedItems.length,
        'stats.pending': newQueue.length
      });
      
      closeModal();
    }

    // 모달 외부 클릭 시 닫기
    document.getElementById('detailModal').addEventListener('click', (e) => {
      if (e.target.id === 'detailModal') {
        closeModal();
      }
    });
  </script>
</body>
</html>